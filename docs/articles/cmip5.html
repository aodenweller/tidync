<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A CMIP5 workflow with tidync • tidync</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">tidync</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cmip5.html">A CMIP5 workflow with tidync</a>
    </li>
    <li>
      <a href="../articles/static-vignettes/tbl_cube.html">NetCDF tbl_cube</a>
    </li>
    <li>
      <a href="../articles/static-vignettes/tidync-examples.html">Tidy NetCDF examples</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hypertidy/tidync">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>A CMIP5 workflow with tidync</h1>
                        <h4 class="author">Michael D. Sumner</h4>
            
            <h4 class="date">2017-08-07</h4>
          </div>

    
    
<div class="contents">
<p>Following here:</p>
<p><a href="https://cran.r-project.org/web/packages/futureheatwaves/vignettes/starting_from_netcdf.html" class="uri">https://cran.r-project.org/web/packages/futureheatwaves/vignettes/starting_from_netcdf.html</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">u &lt;-<span class="st"> "http://cses.washington.edu/rocinante/CMIP5/rcp85/GFDL-ESM2G/tas_day_GFDL-ESM2G_rcp85_r1i1p1_20710101-20751231.nc"</span>

climate_filepath &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"/tmp"</span>, <span class="kw">basename</span>(u))
<span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(climate_filepath)) {
  <span class="kw">download.file</span>(u, climate_filepath, <span class="dt">mode =</span> <span class="st">"wb"</span>)
}</code></pre></div>
<p>Use <code>tidync</code> to we what is in the file, <code>activate</code> to choose the grid of choice and then we can proceed to extract the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidync)
(tnc &lt;-<span class="st"> </span><span class="kw">tidync</span>(climate_filepath))</code></pre></div>
<pre><code>## 
## Data Source (1): tas_day_GFDL-ESM2G_rcp85_r1i1p1_20710101-20751231.nc ...
## 
## Grids (9) &lt;dimension family&gt; : &lt;associated variables&gt; 
## 
## [1]   D2,D1,D0 : tas    **ACTIVE GRID** ( 23652000  values per variable)
## [2]   D3,D0    : time_bnds
## [3]   D3,D1    : lat_bnds
## [4]   D3,D2    : lon_bnds
## [5]   D0       : average_DT, average_T1, average_T2, time
## [6]   D1       : lat
## [7]   D2       : lon
## [8]   D3       : bnds
## [9]   S        : height
## 
## Dimensions (4): 
##   
##   dimension    id  name length unlim coord_dim 
##       &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;lgl&gt;     &lt;lgl&gt; 
## 1        D0     0  time   1825  TRUE      TRUE 
## 2        D1     1   lat     90 FALSE      TRUE 
## 3        D2     2   lon    144 FALSE      TRUE 
## 4        D3     3  bnds      2 FALSE      TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## tnc %&gt;% activate("D2,D1,D0")</code></pre></div>
<p>In this case the variable we want <code>tas</code> is in the already activated grid, so we don’t need to do anything more, but we could have harmlessly chose this grid as in the commented out code.</p>
<p>Now we can explore the axes that are relevant to this space. The <em>axis transforms</em> here are a data frame for each dimension with the index of the grid and possibly the coordinate values of the axis (some dimensions do not have coordinates).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">axes &lt;-<span class="st"> </span>tnc<span class="op">$</span>transforms

## these won't be right because of noleap but tidync could do this too
axes<span class="op">$</span>time<span class="op">$</span>unit &lt;-<span class="st">  </span><span class="kw">as.POSIXct</span>(<span class="st">"2006-01-01 00:00:00"</span>, <span class="dt">tz =</span> <span class="st">"GMT"</span>) <span class="op">+</span><span class="st"> </span>axes<span class="op">$</span>time<span class="op">$</span>time <span class="op">*</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span><span class="dv">3600</span>
nms &lt;-<span class="st"> </span><span class="kw">names</span>(axes)
purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(nms,  <span class="cf">function</span>(axis_name) <span class="kw">summary</span>(axes[[axis_name]][[axis_name]])) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">setNames</span>(nms)</code></pre></div>
<pre><code>## $lon
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.25   90.62  180.00  180.00  269.38  358.75 
## 
## $lat
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  -89.49  -45.00    0.00    0.00   45.00   89.49 
## 
## $time
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   23726   24182   24638   24638   25094   25550 
## 
## $bnds
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.00    1.25    1.50    1.50    1.75    2.00</code></pre>
<p>Hone in on a particular location and get all of the times.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tab &lt;-<span class="st"> </span>tnc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_filter</span>(<span class="dt">lon =</span> index <span class="op">==</span><span class="st"> </span><span class="kw">which.min</span>(<span class="kw">abs</span>(lon <span class="op">-</span><span class="st"> </span><span class="fl">116.4</span>)), 
                     <span class="dt">lat =</span> index <span class="op">==</span><span class="st"> </span><span class="kw">which.min</span>(<span class="kw">abs</span>(lat <span class="op">-</span><span class="st"> </span><span class="fl">39.9</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                     </span><span class="kw">hyper_tibble</span>()
                     
<span class="kw">library</span>(ggplot2)
 <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(tab, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> time, <span class="dt">y =</span> tas)) <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">"Date"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">"Temperature (K)"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Daily modeled near-surface air temperature, 2071-2075"</span>,
                <span class="dt">subtitle =</span> <span class="st">"At model grid point nearest Beijing, China"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_classic</a></span>()</code></pre></div>
<p><img src="cmip5_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>Hone in on a date to get the map.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tas &lt;-<span class="st"> </span>tnc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_filter</span>(<span class="dt">time =</span> index <span class="op">==</span><span class="st"> </span><span class="kw">which</span>(<span class="kw">format</span>(<span class="kw">as.Date</span>(axes<span class="op">$</span>time<span class="op">$</span>unit)) <span class="op">==</span><span class="st"> "2075-07-15"</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_slice</span>()

<span class="kw">image</span>(axes<span class="op">$</span>lon<span class="op">$</span>lon, axes<span class="op">$</span>lat<span class="op">$</span>lat, tas[[<span class="dv">1</span>]], <span class="dt">col =</span> viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/reexports">viridis</a></span>(<span class="dv">100</span>))
maps<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/maps/topics/map">map</a></span>(<span class="st">"world2"</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="cmip5_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(axes<span class="op">$</span>lon<span class="op">$</span>lon)</code></pre></div>
<p><img src="cmip5_files/figure-html/unnamed-chunk-5-2.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">diff</span>(axes<span class="op">$</span>lat<span class="op">$</span>lat))</code></pre></div>
<p><img src="cmip5_files/figure-html/unnamed-chunk-5-3.png" width="672"></p>
<p>We can also get this in <code>ggplot2</code> form, but this clearly shows that the grid is rectlinear and so ggplot2 can’t deal with it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)</code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tas_tab &lt;-<span class="st"> </span>tnc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_filter</span>(<span class="dt">time =</span> index <span class="op">==</span><span class="st"> </span><span class="kw">which</span>(<span class="kw">format</span>(<span class="kw">as.Date</span>(axes<span class="op">$</span>time<span class="op">$</span>unit)) <span class="op">==</span><span class="st"> "2075-07-15"</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">lon =</span> <span class="kw">ifelse</span>(lon <span class="op">&gt;</span><span class="st"> </span><span class="dv">180</span>, <span class="op">-</span>(<span class="dv">360</span> <span class="op">-</span><span class="st"> </span>lon), lon))


<span class="co">#ggplot(tas_tab, aes(lon, lat, fill = tas)) + geom_raster()</span>

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(tas_tab) <span class="op">+</span><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, <span class="dt">color =</span> tas,
                   <span class="dt">size =</span> <span class="fl">0.8</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/borders">borders</a></span>(<span class="st">"world"</span>, <span class="dt">colour=</span><span class="st">"black"</span>, <span class="dt">fill=</span><span class="ot">NA</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">        </span>viridis<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/viridis/topics/scale_viridis">scale_color_viridis</a></span>(<span class="dt">name =</span> <span class="st">"Temperature (C)"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_void</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_quickmap</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Modeled temperature on a day in July 2075"</span>,
                <span class="dt">subtitle =</span> <span class="st">"GFDL-ESM2G model, RCP8.5 experiment, r1i1p1 ensemble member"</span>) </code></pre></div>
<p><img src="cmip5_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michael Sumner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
